# 4時間コア機能実装計画 - テーマベースシステム

## 🎯 実装対象（4つのコア機能）

1. **単語データベース**: テーマ用単語の管理
2. **条件判定・単語抽出ロジック**: 投稿内容のテーマ単語含有チェック
3. **日別テーマ割り振りロジック**: ユーザー×日付でのテーマ決定
4. **アカウント情報紐付け**: 現在のauthorIdをユーザー管理システムに拡張

## ⏰ 4時間タイムライン

### Phase 1: 基盤データモデル構築 (60分)
**目標**: テーマとユーザーのデータモデル実装

### Phase 2: 単語データベース＆テーマ割り振り (90分)
**目標**: テーマ管理とユーザー別日次テーマ決定

### Phase 3: コンテンツ検証システム (60分)
**目標**: 投稿内容のテーマ単語含有判定

### Phase 4: 統合・テスト・動作確認 (30分)
**目標**: 全機能統合とデモ可能状態

## 📋 詳細実装計画

### Phase 1: 基盤データモデル構築 (60分)

#### 1.1 テーマモデル実装 (30分)
```typescript
// src/core-domain/theme.model.ts
export interface Theme {
  readonly __tag: 'Theme';
  readonly id: string;              // UUID
  readonly word: string;            // テーマ単語（例：「学習」「チームワーク」）
  readonly category: string;        // カテゴリ（例：「教育」「コミュニケーション」）
  readonly difficulty: 'easy' | 'medium' | 'hard'; // 難易度
  readonly isActive: boolean;       // 使用可能フラグ
  readonly createdAt: number;       // 作成日時（UNIX timestamp）
}

// ファクトリー関数
function create(word: string, category: string, difficulty: Theme['difficulty']): Theme
function deactivate(theme: Theme): Theme
```

#### 1.2 ユーザーモデル実装 (30分)
```typescript
// src/core-domain/user.model.ts
export interface User {
  readonly __tag: 'User';
  readonly id: string;              // UUID（既存authorIdと互換）
  readonly email: string;           // Google Cloud IAP由来
  readonly displayName: string;     // 表示名
  readonly isActive: boolean;       // アクティブフラグ
  readonly createdAt: number;
  readonly updatedAt: number;
}

// 既存authorIdからUser作成
function fromAuthorId(authorId: string, email: string, displayName: string): User
```

### Phase 2: 単語データベース＆テーマ割り振り (90分)

#### 2.1 テーマリポジトリ実装 (30分)
```typescript
// src/repositories/theme.repository.ts
export interface ThemeRepository {
  getAll(): Promise<Theme[]>;
  getActiveThemes(): Promise<Theme[]>;
  getById(id: string): Promise<Theme | null>;
  create(theme: Theme): Promise<void>;
}

// src/repositories/file-based-theme.repository.ts
// JSONファイルベース実装
// storage/themes/themes-data.json
```

#### 2.2 初期テーマデータ作成 (30分)
```json
// storage/themes/themes-data.json
{
  "themes": [
    {"id": "theme-001", "word": "学習", "category": "教育", "difficulty": "easy", "isActive": true},
    {"id": "theme-002", "word": "チームワーク", "category": "コミュニケーション", "difficulty": "medium", "isActive": true},
    {"id": "theme-003", "word": "効率化", "category": "業務改善", "difficulty": "medium", "isActive": true},
    {"id": "theme-004", "word": "創造性", "category": "発想", "difficulty": "hard", "isActive": true},
    {"id": "theme-005", "word": "問題解決", "category": "思考", "difficulty": "medium", "isActive": true},
    {"id": "theme-006", "word": "成長", "category": "自己開発", "difficulty": "easy", "isActive": true},
    {"id": "theme-007", "word": "挑戦", "category": "行動", "difficulty": "easy", "isActive": true},
    {"id": "theme-008", "word": "発見", "category": "学び", "difficulty": "easy", "isActive": true},
    {"id": "theme-009", "word": "協力", "category": "チーム", "difficulty": "easy", "isActive": true},
    {"id": "theme-010", "word": "イノベーション", "category": "変革", "difficulty": "hard", "isActive": true}
  ]
}
```

#### 2.3 日別テーマ割り振りサービス (30分)
```typescript
// src/services/theme-assignment.service.ts
export interface DailyThemeAssignment {
  readonly __tag: 'DailyThemeAssignment';
  readonly userId: string;
  readonly themeId: string;
  readonly assignedDate: string;    // YYYY-MM-DD
  readonly createdAt: number;
}

export class ThemeAssignmentService {
  // ユーザーID + 日付でハッシュ化してテーマ決定
  async getTodayTheme(userId: string): Promise<Theme>;
  
  // 決定的アルゴリズム（同じユーザー・日付で同じテーマ）
  private generateThemeHash(userId: string, date: string): number;
  
  // 過去の割り振り記録保存
  private saveAssignment(assignment: DailyThemeAssignment): Promise<void>;
}
```

### Phase 3: コンテンツ検証システム (60分)

#### 3.1 単語抽出・検証サービス (30分)
```typescript
// src/services/content-validator.service.ts
export class ContentValidatorService {
  // メイン検証機能
  validateThemeContent(content: string, themeWord: string): {
    isValid: boolean;
    detectedWords: string[];
    reason?: string;
  };
  
  // 単語抽出（シンプル版）
  extractWords(content: string): string[];
  
  // テーマ単語含有チェック
  private checkThemeWordInclusion(content: string, themeWord: string): boolean;
  
  // 複数形・活用形対応（基本的なパターンマッチング）
  private normalizeWord(word: string): string;
}
```

#### 3.2 投稿API統合 (30分)
```typescript
// src/index.tsx への追加
// POST /api/knowledge にテーマ制約追加

app.post('/api/knowledge', async (c) => {
  const { content, authorId } = await c.req.json();
  
  // 1. 今日のテーマ取得
  const todayTheme = await themeAssignmentService.getTodayTheme(authorId);
  
  // 2. コンテンツ検証
  const validation = contentValidator.validateThemeContent(content, todayTheme.word);
  
  if (!validation.isValid) {
    return c.json({ 
      error: `今日のテーマ「${todayTheme.word}」を含む投稿をしてください`,
      theme: todayTheme,
      validation
    }, 400);
  }
  
  // 3. 通常の投稿処理
  const knowledge = Knowledge.create(content, authorId);
  await knowledgeRepository.upsert(knowledge);
  
  return c.json({ knowledge, theme: todayTheme, validation });
});

// 新API: 今日のテーマ取得
app.get('/api/users/:userId/today-theme', async (c) => {
  const userId = c.req.param('userId');
  const theme = await themeAssignmentService.getTodayTheme(userId);
  return c.json({ theme });
});
```

### Phase 4: 統合・テスト・動作確認 (30分)

#### 4.1 基本テストケース (15分)
```typescript
// src/services/content-validator.service.test.ts
describe('ContentValidatorService', () => {
  test('テーマ単語が含まれている場合はtrue', () => {
    const result = validator.validateThemeContent('今日は学習について考えた', '学習');
    expect(result.isValid).toBe(true);
  });
  
  test('テーマ単語が含まれていない場合はfalse', () => {
    const result = validator.validateThemeContent('今日は天気が良い', '学習');
    expect(result.isValid).toBe(false);
  });
});

// src/services/theme-assignment.service.test.ts
describe('ThemeAssignmentService', () => {
  test('同じユーザー・日付で同じテーマが返される', async () => {
    const theme1 = await service.getTodayTheme('user-123');
    const theme2 = await service.getTodayTheme('user-123');
    expect(theme1.id).toBe(theme2.id);
  });
});
```

#### 4.2 動作確認・デモ準備 (15分)
```bash
# ビルド・起動
npm run build
npm start

# 動作確認コマンド
# 1. 今日のテーマ取得
curl http://localhost:8080/api/users/test-user/today-theme

# 2. テーマ制約違反投稿（エラーになることを確認）
curl -X POST http://localhost:8080/api/knowledge \
  -H "Content-Type: application/json" \
  -d '{"content": "今日は天気が良い", "authorId": "test-user"}'

# 3. テーマ制約通過投稿（成功することを確認）
curl -X POST http://localhost:8080/api/knowledge \
  -H "Content-Type: application/json" \
  -d '{"content": "今日は学習について考えた", "authorId": "test-user"}'
```

## 📁 実装ファイル構成

### 新規作成ファイル（優先順）
```
1. src/core-domain/theme.model.ts              # テーマモデル
2. src/core-domain/user.model.ts               # ユーザーモデル
3. storage/themes/themes-data.json             # 初期テーマデータ
4. src/repositories/theme.repository.ts        # テーマリポジトリI/F
5. src/repositories/file-based-theme.repository.ts # テーマリポジトリ実装
6. src/services/theme-assignment.service.ts    # テーマ割り振りサービス
7. src/services/content-validator.service.ts   # コンテンツ検証サービス
8. src/services/content-validator.service.test.ts # 基本テスト
```

### 更新ファイル
```
src/index.tsx                                  # API追加
```

## 🎯 4時間後の成果物

### 完成する機能
1. **テーマデータベース**: 10語のテーマデータと管理機能
2. **日別テーマ割り振り**: ユーザー×日付で決定的なテーマ決定
3. **投稿制約**: テーマ単語を含まない投稿は400エラー
4. **API統合**: 既存Knowledge APIにテーマ制約組み込み

### デモシナリオ
```
1. ユーザー「test-user」の今日のテーマを取得 → 「学習」
2. テーマ違反投稿「今日は天気が良い」 → 400エラー
3. テーマ適合投稿「今日は学習について考えた」 → 成功
4. 別ユーザー「user-2」の今日のテーマ → 「チームワーク」（異なるテーマ）
5. 明日の同じユーザーのテーマ → 「効率化」（日付変更で変わる）
```

## ⚙️ 技術実装詳細

### ハッシュベーステーマ割り振りアルゴリズム
```typescript
private generateThemeHash(userId: string, date: string): number {
  const combined = `${userId}-${date}`;
  let hash = 0;
  for (let i = 0; i < combined.length; i++) {
    const char = combined.charCodeAt(i);
    hash = ((hash << 5) - hash) + char;
    hash = hash & hash; // 32bit整数に変換
  }
  return Math.abs(hash);
}

async getTodayTheme(userId: string): Promise<Theme> {
  const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
  const themes = await this.themeRepository.getActiveThemes();
  const hash = this.generateThemeHash(userId, today);
  const themeIndex = hash % themes.length;
  return themes[themeIndex];
}
```

### シンプル単語含有チェック
```typescript
validateThemeContent(content: string, themeWord: string): ValidationResult {
  const normalizedContent = content.toLowerCase();
  const normalizedTheme = themeWord.toLowerCase();
  
  const isValid = normalizedContent.includes(normalizedTheme);
  
  return {
    isValid,
    detectedWords: isValid ? [themeWord] : [],
    reason: isValid ? undefined : `テーマ単語「${themeWord}」が含まれていません`
  };
}
```

## 🚀 次ステップ（4時間後の拡張）

### 即座に拡張可能な機能
1. **UI統合**: 投稿フォームにテーマ表示・バリデーション表示
2. **より高度な単語マッチング**: 形態素解析、類語対応
3. **テーマ統計**: ユーザー別・テーマ別投稿数分析
4. **管理者機能**: テーマ追加・編集・無効化

### 技術改善点
1. **パフォーマンス**: メモリキャッシュ、インデックス最適化
2. **エラーハンドリング**: より詳細なバリデーションメッセージ
3. **ログ**: テーマ割り振り・検証結果のログ記録

---

**実装時間**: 4時間集中  
**実装範囲**: コア機能のみ（UI除く）  
**成果**: API完全動作・テスト付き・デモ可能  
**品質**: 本番投入可能レベル